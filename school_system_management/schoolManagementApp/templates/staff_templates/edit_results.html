{% extends 'staff_templates/base.html' %}
{% block page_title %} Edit Student Results {% endblock page_title %}
{% block main-content %}
<section class="content">
    <div class="container-fluid">
        <form action="{% url 'edit_student_result' %}" method="post">
            {% csrf_token %}
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">Edit Student Results</h3>
                </div>
                <!-- /.card-header -->
                <!-- form start -->
                <div class="card-body">
                        {{form}}
                    <div class="form-group" style="margin-top:20px;">
                    {%if messages%}
                    {% for message in messages %}
                    {% if message.tags == "error" %}
                      <div id="fail" class="alert alert-danger">{{message}}</div>
                    {% endif %}
                    {% if message.tags == "success" %}
                      <div id="fail" class="alert alert-success">{{message}}</div>
                    {% endif %}
                    {% endfor %}
                  {% endif %}
                </div>
                </div>
                <!-- /.card-body -->
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary" id="fetch_attendance">Edit Results
                    </button>
                </div>
        </form>
    </div>
    </div>
</section>
{% block base_js %}
<script>
    $(document).ready(function () {
        $("#id_session").change(function() {
             fetchStudents();
        });
        $("#id_date").change(function() {
            fetchStudents();
    });
        $("#id_subject_id").change(function() {
            fetchStudents();
    });
        $("#id_students").change(function(){
            fetchResults();
        });
        function fetchStudents(){
            var subject = $("#id_subject_id").val()
            var session = $("#id_session").val()
            var date = $("#id_date").val();
            $.ajax({
                url: '{% url 'get_students' %}',
                type: "POST",
                data: {subject: subject, session: session, date:date}
            })
                .done(function (response) {
                    var json_data = JSON.parse(response)
                    console.log(json_data)
                    var div_data = "";
                    div_data+= "<option value=''>-</option>"
                    for (j in json_data) {
                        div_data += "<option  value='" + json_data[j]['id'] + "'>" + json_data[j]['name'] + "</option>";
                    }
                    $('#id_students').html(div_data);
                })
                .fail(function () {
                    alert("We could not fetch the students. Try again!")
                })
        };

        function fetchResults() {
            var subject = $("#id_subject_id").val()
            var student = $("#id_students").val()
            var date = $("#id_date").val();
            $.ajax({
                url: '{% url 'fetch_student_results' %}',
                type: "POST",
                data: {subject_id: subject, student_id: student, date_id:date}
            })
                .done(function (response) {
                    console.log(response)
                    if(response == "False"){
                        alert("We could not find any results for this student. Try again!")
                    }
                    else {
                        var json_data = JSON.parse(response)
                        $("#id_exam_mark").val(json_data['exam_mark'])
                    }
                })
                .fail(function () {
                    alert("We could not fetch the students. Try again!")
                })
        }
    });
</script>
{% endblock base_js %}
{% endblock main-content %}

